name: Playwright Code Review Agent

on:
  # Manual trigger via checkbox in PR description
  pull_request_target:
    types: [edited]

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.determine.outputs.should_run }}
    steps:
      - name: Check if review checkbox is checked
        id: determine
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -qiE '\[x\]\s*Run Playwright Code Review'; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Checkbox is checked - triggering review"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Checkbox not checked - skipping"
          fi

  review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed Playwright files
        id: changed-files
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "Checking full PR diff: $BASE_SHA..$HEAD_SHA"
          FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" \
            | grep 'apps/backend-e2e/playwright/' \
            | grep -v 'README.md' \
            | grep -v 'CONVENTIONS.md' \
            | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT

          # Count files and calculate tiered max-turns
          FILE_COUNT=$(echo "$FILES" | wc -w | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FILE_COUNT" -gt 0 ]; then
            MAX_TURNS=$(( ((FILE_COUNT - 1) / 10 + 1) * 10 ))
            if [ $MAX_TURNS -gt 50 ]; then MAX_TURNS=50; fi
            echo "max_turns=$MAX_TURNS" >> $GITHUB_OUTPUT
            echo "Found $FILE_COUNT Playwright file(s), setting max-turns to $MAX_TURNS"
          else
            echo "max_turns=10" >> $GITHUB_OUTPUT
            echo "No Playwright files changed"
          fi

      - name: Setup Node.js
        if: steps.changed-files.outputs.file_count > 0
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        if: steps.changed-files.outputs.file_count > 0
        run: npm install -g @anthropic-ai/claude-code

      - name: Check for mock mode
        id: mock-check
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -qiE '\[x\]\s*Mock Review'; then
            echo "mock=true" >> $GITHUB_OUTPUT
          else
            echo "mock=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        if: steps.changed-files.outputs.file_count > 0 && steps.mock-check.outputs.mock == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROMPT="Review the Playwright test changes in this repo.

          Focus on CONVENTIONS.md standards:
          - COB pattern compliance (no raw locators in test files)
          - Selector strategy (prefer data-testid)
          - Auto-waiting assertions (no waitForTimeout, no allTextContents without waiting)
          - Missing await on async operations
          - Code reuse (flag duplicate methods)
          - Avoid overengineering

          Output your review as JSON with this exact structure:
          {
            \"body\": \"Brief summary of the review\",
            \"comments\": [
              {
                \"path\": \"relative/file/path.ts\",
                \"line\": 42,
                \"body\": \"Issue description\n\n\\\`\\\`\\\`suggestion\ncorrected code for that line\n\\\`\\\`\\\`\"
              }
            ]
          }

          IMPORTANT: For each comment, include a suggested fix using GitHub's suggestion syntax.
          The suggestion block should contain the corrected version of that specific line.
          Only output the JSON, nothing else. If no issues found, use empty comments array."

          claude -p "$PROMPT" \
            --max-turns ${{ steps.changed-files.outputs.max_turns || '10' }} \
            --output-format json \
            | jq -r '.result // .content // .' > review.json

          cat review.json

      - name: Mock Claude Review (for testing)
        if: steps.changed-files.outputs.file_count > 0 && steps.mock-check.outputs.mock == 'true'
        run: |
          cat > review.json << 'EOF'
          {
            "body": "Found 3 issues in Playwright tests that need attention.",
            "comments": [
              {
                "path": "apps/backend-e2e/playwright/tests/example.spec.ts",
                "line": 3,
                "body": "**Comment style** - Consider using a more descriptive comment.\n\n```suggestion\n// Playwright test file with intentional convention violations for review testing\n```"
              }
            ]
          }
          EOF
          echo "Mock review generated:"
          cat review.json

      - name: Post Review to PR
        if: steps.changed-files.outputs.file_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Check if review.json exists
          if [[ ! -f review.json ]]; then
            echo "No review output file found"
            exit 0
          fi

          # Extract JSON from markdown code fences if Claude wrapped output in ```json
          # Only strip fences if file STARTS with ``` (not if it contains ``` inside JSON)
          FIRST_LINE=$(head -n1 review.json)
          if [[ "$FIRST_LINE" == '```json'* ]] || [[ "$FIRST_LINE" == '```'* ]]; then
            # Remove first and last lines (the fence markers)
            sed '1d;$d' review.json > review-clean.json
          else
            cp review.json review-clean.json
          fi

          echo "Cleaned JSON:"
          cat review-clean.json

          # Validate JSON
          if ! jq -e '.body' review-clean.json > /dev/null 2>&1; then
            echo "Invalid JSON structure, falling back to comment"
            echo "## ðŸŽ­ Playwright Code Review" > pr-comment.md
            echo "" >> pr-comment.md
            cat review.json >> pr-comment.md
            gh pr comment "$PR_NUMBER" --body-file pr-comment.md
            exit 0
          fi

          # Create the review via GitHub API
          # Build complete JSON payload with commit_id, body, event, and comments
          jq --arg commit "$HEAD_SHA" --arg event "COMMENT" \
            '{commit_id: $commit, body: .body, event: $event, comments: .comments}' \
            review-clean.json > review-payload.json

          echo "Review payload:"
          cat review-payload.json

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}/reviews" \
            --input review-payload.json \
            && echo "Review posted successfully!" \
            || {
              echo "Failed to post review via API, falling back to comment"
              echo "## ðŸŽ­ Playwright Code Review" > pr-comment.md
              echo "" >> pr-comment.md
              cat review.json >> pr-comment.md
              gh pr comment "$PR_NUMBER" --body-file pr-comment.md
            }

      - name: Skip (no Playwright changes)
        if: steps.changed-files.outputs.file_count == 0
        run: echo "No Playwright files changed, skipping review"
